# PR #49098: agent_ui: Fix max tokens error not being shown

_Merged: 2026-02-13T13:32:31Z_
_PR: https://github.com/zed-industries/zed/pull/49098_

## Documentation Suggestions

### Summary
This change adds error handling for the `MaxTokens` stop reason in ACP threads, displaying a clear error message to users when the maximum token limit is reached during agent execution. This is a new user-visible error state that should be documented.

### Suggested Changes

#### 1. docs/src/agent/troubleshooting.md

- **Section**: New section under "Common Issues" or create new "Error Messages" section
- **Change**: Add
- **Target keyword**: agent error messages troubleshooting
- **Frontmatter**:
  ```yaml
  ---
  title: Troubleshooting Agent Issues
  description: Resolve common errors when working with agents in Zed, including token limits and connection issues.
  ---
  ```
- **Links**: 
  - Link to `/agent/overview.md` for general agent concepts
  - Link to `/agent/configuration.md` for model settings
  - Link to `/settings/assistant.md` for assistant configuration
  - Link to `https://zed.dev/agents` for agents marketing page
- **Suggestion**: 

```markdown
## Error Messages

### "Max tokens reached"

> **Preview:** This error handling is available in Zed Preview. It will be included in the next Stable release.

You see this error when the agent's response exceeds the model's maximum token limit. This happens when:

- The agent generates an extremely long response
- The conversation context plus the response exceeds the model's capacity
- Tool outputs are large and consume the available token budget

**To resolve this:**

1. Start a new thread to reduce context size
2. Use a model with a larger token limit in [Assistant settings](/settings/assistant.md)
3. Break your request into smaller, focused tasks
4. Clear tool outputs or previous messages using the thread controls

The token limit varies by modelâ€”check your model provider's documentation for specific limits.
```

- **Full-file brand pass**: Required: yes. Since this appears to be a new file or section, ensure the entire troubleshooting page maintains technical precision, uses direct second-person voice, avoids hedging words, and provides concrete resolution steps. Review all error descriptions for specificity and actionability.

- **Brand voice scorecard**:

  | Criterion            | Score | Notes |
  | -------------------- | ----- | ----- |
  | Technical Grounding  | 5     | Precise technical cause, model-specific details |
  | Natural Syntax       | 4     | Clear, direct language with natural flow |
  | Quiet Confidence     | 4     | States facts without hedging or over-explaining |
  | Developer Respect    | 5     | Provides actionable solutions, references external docs |
  | Information Priority | 5     | Leads with the error, then causes, then solutions |
  | Specificity          | 4     | Concrete steps, though token limits vary by model |
  | Voice Consistency    | 4     | Second person, present tense, imperative |
  | Earned Claims        | 5     | No unearned claims, factual throughout |
  | **TOTAL**            | 36/40 | Pass (all criteria 4+) |

### Notes for Reviewer

- This error was previously unhandled, so users would see generic failure states. Now they receive a specific "Max tokens reached" message.
- The test confirms this error is displayed in the thread UI as a `ThreadError::Other` variant.
- Consider whether this should also link to model configuration docs if they exist separately from assistant settings.
- If `docs/src/agent/troubleshooting.md` doesn't exist, this could alternatively go in an "Error Reference" subsection of the main agent documentation page.
